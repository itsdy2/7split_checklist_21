{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <h3><i class="material-icons">play_arrow</i> 수동 스크리닝 실행</h3>
            <p class="text-muted">
                현재 설정된 기본 전략으로 스크리닝을 수동으로 시작합니다.
                <!-- V V V 수정: 설정 페이지 링크 변경 V V V -->
                <a href="/7split_checklist_21/base" class="btn btn-sm btn-outline-secondary">
                <!-- ^ ^ ^ 수정: 설정 페이지 링크 변경 ^ ^ ^ -->
                    <i class="material-icons" style="font-size:16px;">settings</i> 설정 변경
                </a>
            </p>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-body text-center">
            <button class="btn btn-primary btn-lg" id="run_manual_btn">
                <i class="material-icons">play_arrow</i> 기본 전략 실행
            </button>
            <small id="default_strategy_name" class="form-text text-muted mt-2">(기본 전략: {{ arg.default_strategy }})</small>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">새 전략 추가 가이드</h5>
            <button class="btn btn-sm btn-outline-secondary" type="button" data-toggle="collapse" data-target="#devGuide" aria-expanded="false" aria-controls="devGuide">펼치기/접기</button>
        </div>
        <div id="devGuide" class="collapse">
            <div class="card-body">
                <ol class="mb-3">
                    <li><code>strategies</code> 폴더에 새 파일 생성 (예: <code>my_strategy.py</code>)</li>
                    <li><code>BaseStrategy</code> 상속 클래스 구현: <code>strategy_id</code>, <code>strategy_name</code>, <code>version</code>, <code>required_data</code>, <code>conditions</code>, <code>apply_filters</code></li>
                    <li>서버 재시작 없이도 자동 로드됩니다(동적 디스커버리). 충돌 방지를 위해 <code>strategy_id</code>는 고유하게 지정하세요.</li>
                </ol>
                <pre class="border p-3 bg-light" style="white-space: pre;">
from strategies.base_strategy import BaseStrategy

class MyStrategy(BaseStrategy):
    strategy_id = 'my_strategy'
    strategy_name = '나의 전략'
    version = '1.0.0'
    # 필요 데이터 집합: 'market', 'financial', 'disclosure', 'major_shareholder' 중 선택
    required_data = {'market', 'financial'}

    # 조건 설명 사전: {번호: 설명}
    conditions = {
        1: '시가총액 ≥ 1000억원',
        2: 'PER 5~20',
    }

    def get_info(self):
        return {
            'strategy_id': self.strategy_id,
            'strategy_name': self.strategy_name,
            'version': self.version,
            'description': '간단한 샘플 전략',
            'conditions': self.conditions,
        }

    def apply_filters(self, stock):
        # stock dict: market/financial 등 수집값 포함
        passed = True
        detail = {}
        detail[1] = bool(stock.get('market_cap', 0) >= 1000_0000_00)  # 1000억원
        detail[2] = False
        per = stock.get('per')
        if per is not None:
            detail[2] = 5 <= per <= 20
        passed = all(detail.values())
        return passed, detail
                </pre>
                <div class="small text-muted">
                    더 발전된 예시는 잘 만들어진 샘플 플러그인 구조를 참고하세요: <a href="https://github.com/halfaider/flaskfarmaider" target="_blank">flaskfarmaider</a>
                </div>
            </div>
        </div>
    </div>

    <div id="progress_container" style="display:none;" class="mb-3">
        <div class="alert alert-info">
            <strong>스크리닝 진행 중...</strong>
            <div class="progress mt-2">
                <div id="progress_bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%"></div>
            </div>
            <p id="progress_text" class="mt-2 mb-0">0 / 0 (0%)</p>
        </div>
    </div>
</div>

<script>
// 수동 실행 시작
$('#run_manual_btn').on('click', function() {
    if (!confirm('기본 전략으로 스크리닝을 시작하시겠습니까?')) {
        return;
    }
    
    $(this).prop('disabled', true).text('실행 중...');
    
    console.log("Manual execution button clicked. Strategy:", "{{ arg.default_strategy }}");
    console.log("Request URL:", '/{{ P.package_name }}/screening/command/start/{{ arg.default_strategy }}');
    
    $.ajax({
        url: '/{{ P.package_name }}/screening/command/start/{{ arg.default_strategy }}',
        type: 'POST',
        success: function(response) {
            console.log("Success response:", response);
            if (response.ret === 'success') {
                notify('스크리닝이 시작되었습니다.', 'success');
                $('#progress_container').show();
            } else {
                console.log("Start failed:", response.msg);
                notify('시작 실패: ' + response.msg, 'error');
                $('#run_manual_btn').prop('disabled', false).text('기본 전략 실행');
            }
        },
        error: function(xhr, status, error) {
            console.log("AJAX Error:", error, status, xhr.responseText);
            notify('시작 중 오류가 발생했습니다. 콘솔에서 상세 정보를 확인하세요.', 'error');
            $('#run_manual_btn').prop('disabled', false).text('기본 전략 실행');
        }
    });
});

// SocketIO 진행 상황 수신 (list.html과 동일)
if (typeof socket !== 'undefined') {
    socket.on('7split_screening_progress', function(data) {
        $('#progress_container').show();
        $('#progress_bar').css('width', data.percent + '%');
        $('#progress_text').text(data.current + ' / ' + data.total + ' (' + data.percent + '%)');
    });

    socket.on('7split_screening_complete', function(data) {
        $('#progress_container').hide();
        notify('스크리닝 완료: ' + data.passed + '개 종목 통과', 'success');
        $('#run_manual_btn').prop('disabled', false).text('기본 전략 실행');
        
        // 3초 후 결과 목록 페이지로 이동
        setTimeout(function() {
            // V V V 수정: 결과 페이지 링크 변경 V V V
            location.href = '/7split_checklist_21/screening/list';
            // ^ ^ ^ 수정: 결과 페이지 링크 변경 ^ ^ ^
        }, 3000);
    });
}
</script>

{% endblock %}
