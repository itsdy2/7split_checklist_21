{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
    <form id="setting" name="setting">
        <div class="d-flex justify-content-between align-items-center mb-2" style="position: sticky; top: 0; background: var(--body-bg, #fff); z-index: 2; padding-top: 10px;">
            <h3 class="mb-0"><i class="material-icons">settings</i> 세븐스플릿 스크리닝 설정</h3>
            <div>
                {{ macros.m_button_group([['globalSettingSaveBtn', '설정 저장'], ['reset_db_btn', 'DB 초기화']]) }}
            </div>
        </div>

        {{ macros.m_hr() }}

        <!-- API 설정 -->
        <div class="card mb-3">
            <div class="card-header"><strong>API 설정</strong></div>
            <div class="card-body">
                {{ macros.setting_input_text('dart_api_key', 'DART API 인증키', value=arg.dart_api_key, desc=['DART Open API 인증키를 입력하세요. <a href="https://opendart.fss.or.kr/" target="_blank">DART 홈페이지</a>에서 무료로 발급받을 수 있습니다.'], placeholder='DART Open API 인증키') }}
            </div>
        </div>

        <!-- 알림 설정 -->
        <div class="card mb-3">
            <div class="card-header"><strong>알림 설정</strong></div>
            <div class="card-body">
                {{ macros.setting_checkbox('notification_discord', 'Discord 알림 사용', value=arg.notification_discord) }}
                {{ macros.setting_input_text('discord_webhook_url', 'Discord Webhook URL', value=arg.discord_webhook_url, desc=['Discord 서버 설정 → 연동 → 웹후크에서 생성할 수 있습니다.'], placeholder='https://discord.com/api/webhooks/...') }}
            </div>
        </div>

        <!-- 스케줄 설정 -->
        <div class="card mb-3">
            <div class="card-header"><strong>스케줄 설정</strong></div>
            <div class="card-body">
                {{ macros.global_setting_scheduler_button(arg.is_include, arg.is_running) }}
                {{ macros.setting_checkbox('auto_start', '자동 실행 활성화', value=arg.auto_start, desc=['매일 지정된 시간에 전체 스크리닝을 자동으로 실행합니다.']) }}
                {{ macros.setting_input_text('screening_time', '실행 시간 (평일 기준)', value=arg.screening_time, type='time', desc=['장 시작 전인 오전 9시를 권장합니다.']) }}
            </div>
        </div>

        <!-- 전략 설정 -->
        <div class="card mb-3">
            <div class="card-header"><strong>전략 설정</strong></div>
            <div class="card-body">
                {{ macros.setting_select('default_strategy', '기본 실행 전략', 
                    items=[(s.strategy_id, s.strategy_name) for s in arg.strategies], 
                    value=arg.default_strategy, 
                    desc=['수동 실행 또는 자동 스케줄링 시 사용할 기본 전략을 선택합니다.']
                ) }}
            </div>
        </div>

    </form>
</div>

<script>
$(document).ready(function() {
    // DB 초기화 버튼 클릭
    $('#reset_db_btn').on('click', function(e) {
        e.preventDefault();
        if (!confirm('모든 설정을 초기값으로 되돌리시겠습니까?')) {
            return;
        }
        $.ajax({
            url: '/{{ P.package_name }}/base/ajax/reset_db',
            type: 'POST',
            success: function(response) {
                if (response.ret === 'success') {
                    notify(response.msg, 'success');
                    setTimeout(function() { location.reload(); }, 1000);
                } else {
                    notify(response.msg, 'warning');
                }
            },
            error: function() {
                notify('초기화 중 오류가 발생했습니다.', 'error');
            }
        });
    });
});
</script>

{% endblock %}
