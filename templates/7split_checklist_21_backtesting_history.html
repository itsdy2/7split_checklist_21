{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="mb-0"><i class="material-icons">history</i> 백테스트 이력</h3>
        <button id="refresh-history-btn" class="btn btn-outline-primary"><i class="material-icons">refresh</i> 새로고침</button>
    </div>

    {{ macros.m_hr() }}

    <div class="table-responsive">
        <table class="table table-striped">
            <thead class="thead-dark">
                <tr>
                    <th scope="col">#</th>
                    <th scope="col">전략</th>
                    <th scope="col">기간</th>
                    <th scope="col">초기 자본</th>
                    <th scope="col">최종 가치</th>
                    <th scope="col">총 수익률</th>
                    <th scope="col">CAGR</th>
                    <th scope="col">샤프 비율</th>
                    <th scope="col">실행 일시</th>
                    <th scope="col">상태</th>
                </tr>
            </thead>
            <tbody id="history-table-body">
                {% for history in arg.histories %}
                <tr>
                    <th scope="row">{{ history.id }}</th>
                    <td>{{ history.strategy_name }}</td>
                    <td>{{ history.period }}</td>
                    <td class="text-right">{{ "{:,}".format(history.initial_capital|default(0)|int) }}원</td>
                    <td class="text-right">{{ "{:,}".format(history.final_value|default(0)|int) }}원</td>
                    <td class="text-right">{{ "%.2f"|format(history.total_return|default(0)) }}%</td>
                    <td class="text-right">{{ "%.2f"|format(history.cagr|default(0)) }}%</td>
                    <td class="text-right">{{ "%.2f"|format(history.sharpe_ratio|default(0)) }}</td>
                    <td>{{ history.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <span class="badge badge-success">{{ history.status }}</span>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="10" class="text-center text-muted">백테스트 이력이 없습니다.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if arg.pagination %}
    <!-- 페이징 -->
    <nav aria-label="백테스트 이력 페이징">
        <ul class="pagination justify-content-center">
            {% if arg.pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ arg.pagination.prev_num }}">이전</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">이전</a>
                </li>
            {% endif %}
            
            {% for page_num in arg.pagination.iter_pages() %}
                {% if page_num %}
                    {% if page_num != arg.pagination.page %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item active">
                            <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#">…</a>
                    </li>
                {% endif %}
            {% endfor %}
            
            {% if arg.pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ arg.pagination.next_num }}">다음</a>
                </li>
            {% else %}
                <li class="page-item disabled">
                    <a class="page-link" href="#">다음</a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
$('#refresh-history-btn').on('click', function() {
    location.reload();
});

// 페이지 로드 시 이력 갱신 (필요시)
// setInterval(function() {
//     $.ajax({
//         url: '/{{ P.package_name }}/backtesting/ajax/get_backtest_history',
//         type: 'POST',
//         success: function(response) {
//             if (response.ret === 'success') {
//                 // 여기에 최신 데이터로 UI 갱신 로직 추가 가능
//             }
//         }
//     });
// }, 30000); // 30초마다 갱신
</script>

{% endblock %}